
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="usm machine learning course">
      
      
        <meta name="author" content="Sebastian Azocar">
      
      
      <link rel="icon" href="../../images/logo_python.svg">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.15">
    
    
      
        <title>Causal Forests & Heterogeneous Treatment Effects - Machine Learning and Business Applications</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.c382b1dc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#causal-forests-heterogeneous-effects-hte" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../.." title="Machine Learning and Business Applications" class="md-header__button md-logo" aria-label="Machine Learning and Business Applications" data-md-component="logo">
      
  <img src="../../images/logo.bmp" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Machine Learning and Business Applications
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Causal Forests & Heterogeneous Treatment Effects
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Machine Learning and Business Applications" class="md-nav__button md-logo" aria-label="Machine Learning and Business Applications" data-md-component="logo">
      
  <img src="../../images/logo.bmp" alt="logo">

    </a>
    Machine Learning and Business Applications
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Program
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Program" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Program
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../programa/" class="md-nav__link">
        📚 Evaluaciones del curso
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Classes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Classes" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Classes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../clases/clases/" class="md-nav__link">
        Classes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Exercises
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Exercises" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Exercises
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../exercises/exercises/" class="md-nav__link">
        Exercises
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Datasets
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Datasets" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Datasets
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../datasets/datasets/" class="md-nav__link">
        Datasets
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Assessments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Assessments" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Assessments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assessments/project1/" class="md-nav__link">
        📊 Project 1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../assessments/project2.pdf" class="md-nav__link">
        📈 Project 2
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#concepts-in-60-seconds" class="md-nav__link">
    🧠 Concepts in 60 seconds
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#latam-flavored-practical-examples" class="md-nav__link">
    ✈️ LATAM-flavored practical examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-a-causal-forest-does-high-level" class="md-nav__link">
    🧩 What a Causal Forest does (high-level)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-you-need" class="md-nav__link">
    🧪 Data you need
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identification-checklist-observational-or-randomized" class="md-nav__link">
    🧮 Identification checklist (observational or randomized)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training-recipe-conceptual" class="md-nav__link">
    🛠️ Training recipe (conceptual)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#turning-hattaux-into-a-business-policy" class="md-nav__link">
    💸 Turning \(\hat{\tau}(x)\) into a business policy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-evaluate-hte-targeting" class="md-nav__link">
    📊 How to evaluate HTE targeting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interpretability-debugging" class="md-nav__link">
    🔍 Interpretability &amp; debugging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pitfalls-and-fixes" class="md-nav__link">
    ⚠️ Pitfalls (and fixes)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#worked-latam-examples-from-hte-to-action" class="md-nav__link">
    🧰 Worked LATAM examples (from HTE to action)
  </a>
  
    <nav class="md-nav" aria-label="🧰 Worked LATAM examples (from HTE to action)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-subject-line-uplift-open-rate" class="md-nav__link">
    1) Subject line uplift (Open Rate)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-content-personalization-uplift-ctor" class="md-nav__link">
    2) Content personalization uplift (CTOR)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-purchaserevenue-uplift-conversion-or-rpr" class="md-nav__link">
    3) Purchase/revenue uplift (Conversion or RPR)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#non-inferiority-within-hte-when-simplicity-helps" class="md-nav__link">
    🧪 Non-inferiority within HTE (when simplicity helps)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-checklist" class="md-nav__link">
    🧾 Deployment checklist
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tooling-pick-your-stack" class="md-nav__link">
    🧰 Tooling (pick your stack)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#glossary" class="md-nav__link">
    📚 Glossary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="causal-forests-heterogeneous-effects-hte">🌲 Causal Forests &amp; Heterogeneous Effects (HTE)</h1>
<blockquote>
<p>Goal: move beyond a <strong>single average lift</strong> and learn <strong>for whom</strong> the treatment works best.<br />
We estimate <strong>individualized effects</strong> (a.k.a. CATE) and turn them into <strong>targeting policies</strong>.</p>
</blockquote>
<hr />
<h2 id="concepts-in-60-seconds">🧠 Concepts in 60 seconds</h2>
<ul>
<li><strong>ATE (average treatment effect):</strong> single number: “on average, B beats A by +0.4 pp.”</li>
<li>
<p><strong>CATE / HTE:</strong> effect <strong>by user profile</strong> <span class="arithmatex">\(x\)</span>:<br />
  $$
  \tau(x) = \mathbb{E}[Y(1) - Y(0) \mid X=x]
  $$
  Think: <em>“How much lift do we expect if we email </em><em>this</em><em> customer with </em><em>this</em><em> subject/personalization?”</em></p>
</li>
<li>
<p><strong>Why it matters for an airline:</strong></p>
</li>
<li>✉️ Some flyers open <em>any</em> LATAM email (subject doesn’t matter).  </li>
<li>🧭 Others only click when <strong>personalized routes</strong> (e.g., SCL→LIM) appear.  </li>
<li>💳 High-value/loyalty segments may <strong>convert</strong> with milder nudges; casual browsers may need <strong>stronger offers</strong>.<br />
  ⇒ <strong>Different people, different effects</strong> → smarter targeting.</li>
</ul>
<hr />
<h2 id="latam-flavored-practical-examples">✈️ LATAM-flavored practical examples</h2>
<ol>
<li><strong>Subject lines (Open Rate as outcome):</strong>  </li>
<li>Segment by <strong>recency of engagement</strong>, <strong>device</strong>, <strong>country</strong>.  </li>
<li>
<p>Causal forest finds higher lift for “✅ Limited-time fares SCL→LIM” among <strong>recent searchers of LIM</strong> on <strong>mobile</strong> in <strong>Chile</strong>.</p>
</li>
<li>
<p><strong>Content personalization (CTOR as outcome):</strong>  </p>
</li>
<li>Tiles with <strong>Top-3 destinations</strong> vs <strong>generic grid</strong>.  </li>
<li>
<p>Lift is larger for <strong>users with high search intensity</strong> in the last 7 days and <strong>Medallion-like loyalty tiers</strong>.</p>
</li>
<li>
<p><strong>Conversion / Revenue per recipient:</strong>  </p>
</li>
<li>Personalized fare blocks vs generic offers.  </li>
<li>Lift concentrated among <strong>price-sensitive</strong> flyers (historically buy with low fares), <strong>short-haul</strong> routes, and <strong>weekend searchers</strong>.</li>
</ol>
<blockquote>
<p>🎯 <strong>Policy:</strong> target only users with <strong>predicted <span class="arithmatex">\(\hat{\tau}(x)\)</span></strong> above a <strong>break-even threshold</strong> (see below).</p>
</blockquote>
<hr />
<h2 id="what-a-causal-forest-does-high-level">🧩 What a Causal Forest does (high-level)</h2>
<ul>
<li>Learns splits on features <span class="arithmatex">\(X\)</span> (recency, route interest, loyalty, device, country, etc.) that best reveal <strong>differences in treatment effect</strong>.</li>
<li>Produces a <strong>local estimate</strong> <span class="arithmatex">\(\hat{\tau}(x)\)</span> for each user.</li>
<li>Often implemented as part of <strong>generalized random forests</strong> (GRF) or via <strong>uplift trees/forests</strong>.</li>
<li>Related approaches: <strong>T-/S-/X-learners</strong>, <strong>DR/orthogonal learners</strong>, <strong>meta-learners</strong>.</li>
</ul>
<hr />
<h2 id="data-you-need">🧪 Data you need</h2>
<ul>
<li><strong>Treatment</strong> <span class="arithmatex">\(T \in \{0,1\}\)</span>: e.g., <em>Personalized content = 1</em>, <em>Generic = 0</em>.</li>
<li><strong>Outcome</strong> <span class="arithmatex">\(Y\)</span>: depends on test goal  </li>
<li>subject lines → <code>open_rate</code> (binary at user-level: opened or not),</li>
<li>personalization → <code>CTOR</code> (binary click given open) <strong>or</strong> click (binary) with opens as a covariate,</li>
<li>sales → <code>conversion</code> (binary purchase) and/or <strong>RPR</strong> (continuous revenue per recipient).</li>
<li><strong>Covariates</strong> <span class="arithmatex">\(X\)</span>:  </li>
<li>demographics/geo (country/market), device, language, loyalty tier, prior engagement (opens/clicks), search history (routes/dates), price sensitivity proxies, recency/frequency/monetary (RFM).</li>
</ul>
<blockquote>
<p>🔒 <strong>No leakage:</strong> only include covariates known <strong>before</strong> sending the email.</p>
</blockquote>
<hr />
<h2 id="identification-checklist-observational-or-randomized">🧮 Identification checklist (observational or randomized)</h2>
<ul>
<li><strong>Randomized email A/B:</strong> great—positivity is likely OK.  </li>
<li><strong>Observational:</strong> you must model <strong>propensity</strong> <span class="arithmatex">\(e(x)=\Pr(T=1\mid X)\)</span> and <strong>outcomes</strong> <span class="arithmatex">\(m_t(x)=\mathbb{E}[Y\mid X,T=t]\)</span>. Use <strong>orthogonal/doubly robust</strong> estimators + <strong>cross-fitting</strong> to reduce bias.</li>
</ul>
<blockquote>
<p>✅ <strong>Overlap/positivity:</strong> ensure <span class="arithmatex">\(0.05 \le e(x) \le 0.95\)</span> across key segments; trim if needed.</p>
</blockquote>
<hr />
<h2 id="training-recipe-conceptual">🛠️ Training recipe (conceptual)</h2>
<ol>
<li><strong>Split data:</strong> train/validation/test (or cross-fitting folds).  </li>
<li><strong>Nuisance models:</strong> estimate <span class="arithmatex">\( \hat{e}(x) \)</span> and <span class="arithmatex">\( \hat{m}_0(x), \hat{m}_1(x) \)</span> (GBM/trees/logit).  </li>
<li><strong>Orthogonal signal (DR score):</strong> form a pseudo-outcome that isolates treatment effect.  </li>
<li><strong>Causal forest / GRF:</strong> fit on the pseudo-outcome to learn <span class="arithmatex">\(\hat{\tau}(x)\)</span>.  </li>
<li><strong>Calibrate:</strong> check that average <span class="arithmatex">\(\hat{\tau}(x)\)</span> ≈ ATE on a holdout.  </li>
<li><strong>Policy rule:</strong> score users; target top deciles where <span class="arithmatex">\(\hat{\tau}(x)\)</span> clears <strong>break-even</strong>.</li>
</ol>
<blockquote>
<p>🧪 Alternatives: <strong>Uplift forests/trees</strong> (split criteria maximize outcome difference), <strong>X-learner</strong> (good with treatment imbalance), <strong>T-learner</strong> (two models), <strong>S-learner</strong> (single model with T as a feature).</p>
</blockquote>
<hr />
<h2 id="turning-hattaux-into-a-business-policy">💸 Turning <span class="arithmatex">\(\hat{\tau}(x)\)</span> into a business policy</h2>
<p>Let:
- <span class="arithmatex">\(v\)</span> = net margin per conversion (or expected value per purchase),
- <span class="arithmatex">\(c\)</span> = incremental <strong>per-recipient</strong> cost of the treatment,
- <span class="arithmatex">\(\hat{\tau}(x)\)</span> = predicted <strong>absolute lift</strong> in conversion for user <span class="arithmatex">\(x\)</span>.</p>
<p><strong>Target if:</strong><br />
$$
\hat{\tau}(x)\cdot v \ \ge\ c \quad\Rightarrow\quad \hat{\tau}(x) \ge \frac{c}{v}
$$</p>
<p><strong>Email example:</strong> <span class="arithmatex">\(c= \$0.002\)</span>, <span class="arithmatex">\(v=\$25\)</span> ⇒ threshold <span class="arithmatex">\(=0.008\%\)</span> (0.008 pp).<br />
Score all recipients; <strong>email only</strong> those above the threshold (and respect caps/guardrails).</p>
<blockquote>
<p>For <strong>open rate</strong> / <strong>CTOR</strong> policies, convert lift to <strong>expected conversion/revenue</strong> via a simple funnel model (OR → click → conversion → revenue) to compare against cost.</p>
</blockquote>
<hr />
<h2 id="how-to-evaluate-hte-targeting">📊 How to evaluate HTE targeting</h2>
<ul>
<li><strong>Uplift/Qini curves &amp; AUUC:</strong> rank users by <span class="arithmatex">\(\hat{\tau}(x)\)</span>; plot incremental outcomes vs random.  </li>
<li><strong>Deciles:</strong> report incremental conversions/revenue for top 10%, 20%, …  </li>
<li><strong>Policy risk:</strong> simulate “treat top-k%” on a <strong>held-out</strong> dataset.  </li>
<li><strong>Calibration:</strong> average predicted uplift vs realized uplift by bins.  </li>
<li><strong>Guardrails:</strong> unsubscribes/complaints/latency by decile—don’t concentrate harm.</li>
</ul>
<blockquote>
<p>📈 <strong>Success:</strong> top deciles show <strong>steeper uplift</strong> and <strong>positive net value</strong> after costs.</p>
</blockquote>
<hr />
<h2 id="interpretability-debugging">🔍 Interpretability &amp; debugging</h2>
<ul>
<li><strong>Global view:</strong> which features drive high <span class="arithmatex">\(\hat{\tau}(x)\)</span>? (e.g., recent route search for LIM, weekend searchers, mobile users in CL).  </li>
<li><strong>Profiles:</strong> partial dependence or ICE on key features.  </li>
<li><strong>Sanity checks:</strong>  </li>
<li><span class="arithmatex">\(\text{mean}(\hat{\tau}(X)) \approx \widehat{\text{ATE}}\)</span> on holdout.  </li>
<li>Overlap: are extreme segments only in one arm?  </li>
<li>Stability: similar patterns across weeks/markets?</li>
</ul>
<hr />
<h2 id="pitfalls-and-fixes">⚠️ Pitfalls (and fixes)</h2>
<ul>
<li><strong>Leakage:</strong> future info or post-send signals in <span class="arithmatex">\(X\)</span> → restrict to <strong>pre-send</strong> features.  </li>
<li><strong>Sparse segments:</strong> tiny leaves → high-variance effects → set <strong>min leaf size</strong>, enforce <strong>regularization</strong>.  </li>
<li><strong>Imbalance:</strong> if treatment≪control, prefer <strong>X-learner</strong> or weight samples.  </li>
<li><strong>Outcome rarity:</strong> conversion is low → consider longer windows, composite targets, or model <strong>revenue</strong> with robust stats.  </li>
<li><strong>Non-stationarity:</strong> effects drift by season/holiday → retrain, include time features, monitor.</li>
</ul>
<hr />
<h2 id="worked-latam-examples-from-hte-to-action">🧰 Worked LATAM examples (from HTE to action)</h2>
<h3 id="1-subject-line-uplift-open-rate">1) Subject line uplift (Open Rate)</h3>
<ul>
<li><strong>Setup:</strong> <code>T=1</code> if subject includes <strong>route + time-bound</strong> (e.g., “SCL→LIM fares this week”).  </li>
<li><strong>HTE finding:</strong> largest <span class="arithmatex">\(\hat{\tau}(x)\)</span> among <strong>recent searchers of LIM</strong>, <strong>mobile</strong>, <strong>Spanish CL locale</strong>.  </li>
<li><strong>Policy:</strong> ship that subject only to the <strong>top 30%</strong> by <span class="arithmatex">\(\hat{\tau}(x)\)</span>; control overall volume via caps.  </li>
<li><strong>Check:</strong> top 30% shows uplift in OR <strong>and</strong> no drop in <strong>CTOR</strong> or <strong>conversion</strong>.</li>
</ul>
<h3 id="2-content-personalization-uplift-ctor">2) Content personalization uplift (CTOR)</h3>
<ul>
<li><strong>Setup:</strong> <code>T=1</code> personalized tiles (Top-3 likely destinations) vs generic grid.  </li>
<li><strong>HTE finding:</strong> lift concentrated in <strong>high recency searches (≤7 days)</strong> + <strong>loyalty tier L1+</strong> + <strong>short-haul</strong> interest.  </li>
<li><strong>Policy:</strong> send personalized block to <strong>top deciles by <span class="arithmatex">\(\hat{\tau}\)</span></strong>; generic to the rest.  </li>
<li><strong>Outcome:</strong> higher <strong>CTOR</strong>, and in holdout, <strong>conversion</strong> lifts for top deciles.</li>
</ul>
<h3 id="3-purchaserevenue-uplift-conversion-or-rpr">3) Purchase/revenue uplift (Conversion or RPR)</h3>
<ul>
<li><strong>Setup:</strong> <code>T=1</code> includes <strong>fare callouts</strong> and <strong>date suggestions</strong>.  </li>
<li><strong>HTE finding:</strong> largest revenue uplift for <strong>price-sensitive</strong> histories + <strong>weekend searchers</strong>.  </li>
<li><strong>Policy:</strong> treat top deciles where <span class="arithmatex">\(\hat{\tau}(x)\cdot v \ge c\)</span>; skip others.  </li>
<li><strong>Result:</strong> positive <strong>net value</strong> after cost, guardrails steady.</li>
</ul>
<hr />
<h2 id="non-inferiority-within-hte-when-simplicity-helps">🧪 Non-inferiority within HTE (when simplicity helps)</h2>
<p>If a <strong>simpler</strong> template has slightly lower predicted uplift, adopt it for users where <span class="arithmatex">\(\hat{\tau}(x)\)</span> is <strong>below</strong> a small <strong>NI margin</strong> <span class="arithmatex">\(\delta_{NI}\)</span>, but keep the complex/personalized variant for <strong>high-<span class="arithmatex">\(\hat{\tau}\)</span></strong> users. Mixed policy = <strong>cost-effective</strong>.</p>
<hr />
<h2 id="deployment-checklist">🧾 Deployment checklist</h2>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Clear <strong>objective &amp; outcome</strong> (OR, CTOR, conversion, RPR).  </li>
<li class="task-list-item"><input type="checkbox" disabled/> Clean <strong>pre-send</strong> features <span class="arithmatex">\(X\)</span>; no leakage.  </li>
<li class="task-list-item"><input type="checkbox" disabled/> Overlap check <span class="arithmatex">\(0.05 \le \hat{e}(x) \le 0.95\)</span>.  </li>
<li class="task-list-item"><input type="checkbox" disabled/> Proper <strong>cross-fitting/DR</strong> (if observational).  </li>
<li class="task-list-item"><input type="checkbox" disabled/> Holdout for <strong>calibration</strong> and <strong>policy evaluation</strong>.  </li>
<li class="task-list-item"><input type="checkbox" disabled/> Decision rule: <strong><span class="arithmatex">\(\hat{\tau}(x)\)</span> vs break-even</strong>.  </li>
<li class="task-list-item"><input type="checkbox" disabled/> Frequency caps, eligibility, <strong>guardrails</strong>.  </li>
<li class="task-list-item"><input type="checkbox" disabled/> Monitoring: uplift drift, seasonality, market shifts.  </li>
</ul>
<hr />
<h2 id="tooling-pick-your-stack">🧰 Tooling (pick your stack)</h2>
<ul>
<li><strong>Python:</strong> <code>econml</code> (DRLearner, CausalForestDML), <code>causalml</code> (uplift trees/forests, metrics), <code>sklift</code>.  </li>
<li><strong>R:</strong> <code>grf</code> (Causal Forest), <code>uplift</code>.  </li>
<li><strong>Metrics:</strong> Qini/AUUC, decile tables, policy simulation.</li>
</ul>
<hr />
<h2 id="glossary">📚 Glossary</h2>
<ul>
<li><strong>CATE / HTE:</strong> Individualized effect <span class="arithmatex">\(\tau(x)\)</span>.  </li>
<li><strong>Propensity <span class="arithmatex">\(e(x)\)</span>:</strong> <span class="arithmatex">\(\Pr(T=1\mid X)\)</span>.  </li>
<li><strong>DR / Orthogonal:</strong> Estimators robust to misspecification of nuisance models.  </li>
<li><strong>Qini / AUUC:</strong> Measures of uplift ranking quality.  </li>
<li><strong>Policy rule:</strong> Treat when <span class="arithmatex">\(\hat{\tau}(x)\)</span> exceeds value-based threshold.</li>
</ul>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Volver al principio
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/hizocar" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.top", "content.code.annotate", "search.suggest", "search.highlight"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a6c66575.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>